// Authentication Editor Component
// For configuring request authentication (Bearer, Basic, API Key, OAuth2)

import { LineEdit, ComboBox, Button, CheckBox } from "std-widgets.slint";
import { VortexPalette, VortexTypography, VortexSpacing, VortexShape } from "../theme.slint";

// Auth type: 0=None, 1=Bearer, 2=Basic, 3=API Key, 4=OAuth2 Client Credentials, 5=OAuth2 Auth Code
export component AuthEditor inherits Rectangle {
    in property <string> title: "Authorization";
    in-out property <int> auth-type: 0;  // 0=None, 1=Bearer, 2=Basic, 3=API Key, 4=OAuth2 CC, 5=OAuth2 AC
    in-out property <string> bearer-token: "";
    in-out property <string> bearer-prefix: "Bearer";
    in-out property <string> basic-username: "";
    in-out property <string> basic-password: "";
    in-out property <string> api-key-name: "";
    in-out property <string> api-key-value: "";
    in-out property <int> api-key-location: 0;  // 0=Header, 1=Query
    // OAuth2 Client Credentials
    in-out property <string> oauth2-token-url: "";
    in-out property <string> oauth2-client-id: "";
    in-out property <string> oauth2-client-secret: "";
    in-out property <string> oauth2-scope: "";
    // OAuth2 Authorization Code (additional fields)
    in-out property <string> oauth2-auth-url: "";
    in-out property <string> oauth2-redirect-uri: "http://localhost:8080/callback";
    // OAuth2 token state
    in property <string> oauth2-token-status: "";  // "none", "valid", "expired", "fetching"
    in property <string> oauth2-token-preview: "";  // Partial token display
    in property <bool> collapsed: false;

    callback auth-type-changed(int);
    callback bearer-token-changed(string);
    callback bearer-prefix-changed(string);
    callback basic-credentials-changed(string, string);
    callback api-key-changed(string, string, int);
    callback oauth2-client-credentials-changed(string, string, string, string);
    callback oauth2-auth-code-changed(string, string, string, string, string, string);
    callback oauth2-get-token();
    callback oauth2-clear-token();
    callback toggle-collapsed();

    property <[string]> auth-types: ["No Auth", "Bearer Token", "Basic Auth", "API Key", "OAuth2 Client Credentials", "OAuth2 Authorization Code"];
    property <[string]> api-key-locations: ["Header", "Query Param"];

    background: VortexPalette.bg-primary;
    border-radius: VortexShape.radius-sm;
    border-width: 1px;
    border-color: VortexPalette.border-default;

    VerticalLayout {
        // Header bar
        Rectangle {
            height: 36px;
            background: VortexPalette.bg-secondary;
            border-radius: collapsed ? VortexShape.radius-sm : 0;

            HorizontalLayout {
                padding: VortexSpacing.sm;
                alignment: space-between;

                HorizontalLayout {
                    spacing: VortexSpacing.sm;

                    // Collapse toggle
                    Rectangle {
                        width: 20px;
                        height: 20px;

                        Text {
                            text: collapsed ? "\u{25B6}" : "\u{25BC}"; // Right/down triangle
                            color: VortexPalette.text-secondary;
                            font-size: VortexTypography.font-xs;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }

                        TouchArea {
                            clicked => { toggle-collapsed(); }
                        }
                    }

                    Text {
                        text: title;
                        color: VortexPalette.text-primary;
                        font-size: VortexTypography.font-base;
                        font-weight: VortexTypography.weight-bold;
                        vertical-alignment: center;
                    }

                    // Auth type indicator
                    if auth-type > 0: Rectangle {
                        height: 20px;
                        width: auth-type == 1 ? 60px : auth-type == 2 ? 50px : auth-type == 3 ? 55px : auth-type == 4 ? 75px : 85px;
                        background: auth-type >= 4 ? VortexPalette.accent : VortexPalette.status-success;
                        border-radius: VortexShape.radius-sm;

                        Text {
                            text: auth-type == 1 ? "Bearer" : auth-type == 2 ? "Basic" : auth-type == 3 ? "API Key" : auth-type == 4 ? "OAuth2 CC" : "OAuth2 AC";
                            color: white;
                            font-size: VortexTypography.font-xs;
                            font-weight: VortexTypography.weight-bold;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }

                // Auth type selector (always visible in header)
                ComboBox {
                    width: 120px;
                    model: auth-types;
                    current-index <=> auth-type;
                    selected(value) => {
                        auth-type-changed(self.current-index);
                    }
                }
            }
        }

        // Content (hidden when collapsed)
        if !collapsed && auth-type > 0: Rectangle {
            height: auth-type == 1 ? 120px : auth-type == 2 ? 120px : auth-type == 3 ? 160px : auth-type == 4 ? 280px : 340px;
            background: VortexPalette.bg-tertiary;

            VerticalLayout {
                padding: VortexSpacing.md;
                spacing: VortexSpacing.sm;

                // Bearer Token
                if auth-type == 1: VerticalLayout {
                    spacing: VortexSpacing.sm;

                    HorizontalLayout {
                        spacing: VortexSpacing.md;

                        VerticalLayout {
                            horizontal-stretch: 1;
                            spacing: VortexSpacing.xs;

                            Text {
                                text: "Token";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-sm;
                            }

                            Rectangle {
                                height: 32px;
                                background: VortexPalette.bg-input;
                                border-radius: VortexShape.radius-sm;
                                border-width: 1px;
                                border-color: VortexPalette.border-default;

                                LineEdit {
                                    text <=> bearer-token;
                                    placeholder-text: "JWT token or {{variable}}";
                                    font-size: VortexTypography.font-sm;
                                    edited => {
                                        bearer-token-changed(self.text);
                                    }
                                }
                            }
                        }

                        VerticalLayout {
                            width: 100px;
                            spacing: VortexSpacing.xs;

                            Text {
                                text: "Prefix";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-sm;
                            }

                            Rectangle {
                                height: 32px;
                                background: VortexPalette.bg-input;
                                border-radius: VortexShape.radius-sm;
                                border-width: 1px;
                                border-color: VortexPalette.border-default;

                                LineEdit {
                                    text <=> bearer-prefix;
                                    placeholder-text: "Bearer";
                                    font-size: VortexTypography.font-sm;
                                    edited => {
                                        bearer-prefix-changed(self.text);
                                    }
                                }
                            }
                        }
                    }
                }

                // Basic Auth
                if auth-type == 2: VerticalLayout {
                    spacing: VortexSpacing.sm;

                    VerticalLayout {
                        spacing: VortexSpacing.xs;

                        Text {
                            text: "Username";
                            color: VortexPalette.text-secondary;
                            font-size: VortexTypography.font-sm;
                        }

                        Rectangle {
                            height: 32px;
                            background: VortexPalette.bg-input;
                            border-radius: VortexShape.radius-sm;
                            border-width: 1px;
                            border-color: VortexPalette.border-default;

                            LineEdit {
                                text <=> basic-username;
                                placeholder-text: "Username or {{variable}}";
                                font-size: VortexTypography.font-sm;
                                edited => {
                                    basic-credentials-changed(self.text, basic-password);
                                }
                            }
                        }
                    }

                    VerticalLayout {
                        spacing: VortexSpacing.xs;

                        Text {
                            text: "Password";
                            color: VortexPalette.text-secondary;
                            font-size: VortexTypography.font-sm;
                        }

                        Rectangle {
                            height: 32px;
                            background: VortexPalette.bg-input;
                            border-radius: VortexShape.radius-sm;
                            border-width: 1px;
                            border-color: VortexPalette.border-default;

                            LineEdit {
                                text <=> basic-password;
                                placeholder-text: "Password or {{variable}}";
                                font-size: VortexTypography.font-sm;
                                input-type: password;
                                edited => {
                                    basic-credentials-changed(basic-username, self.text);
                                }
                            }
                        }
                    }
                }

                // API Key
                if auth-type == 3: VerticalLayout {
                    spacing: VortexSpacing.sm;

                    HorizontalLayout {
                        spacing: VortexSpacing.md;

                        VerticalLayout {
                            horizontal-stretch: 1;
                            spacing: VortexSpacing.xs;

                            Text {
                                text: "Key Name";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-sm;
                            }

                            Rectangle {
                                height: 32px;
                                background: VortexPalette.bg-input;
                                border-radius: VortexShape.radius-sm;
                                border-width: 1px;
                                border-color: VortexPalette.border-default;

                                LineEdit {
                                    text <=> api-key-name;
                                    placeholder-text: "X-API-Key";
                                    font-size: VortexTypography.font-sm;
                                    edited => {
                                        api-key-changed(self.text, api-key-value, api-key-location);
                                    }
                                }
                            }
                        }

                        VerticalLayout {
                            width: 120px;
                            spacing: VortexSpacing.xs;

                            Text {
                                text: "Add to";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-sm;
                            }

                            ComboBox {
                                height: 32px;
                                model: api-key-locations;
                                current-index: api-key-location;
                                selected(value) => {
                                    api-key-changed(api-key-name, api-key-value, self.current-index);
                                }
                            }
                        }
                    }

                    VerticalLayout {
                        spacing: VortexSpacing.xs;

                        Text {
                            text: "Key Value";
                            color: VortexPalette.text-secondary;
                            font-size: VortexTypography.font-sm;
                        }

                        Rectangle {
                            height: 32px;
                            background: VortexPalette.bg-input;
                            border-radius: VortexShape.radius-sm;
                            border-width: 1px;
                            border-color: VortexPalette.border-default;

                            LineEdit {
                                text <=> api-key-value;
                                placeholder-text: "API key value or {{variable}}";
                                font-size: VortexTypography.font-sm;
                                edited => {
                                    api-key-changed(api-key-name, self.text, api-key-location);
                                }
                            }
                        }
                    }
                }

                // OAuth2 Client Credentials
                if auth-type == 4: VerticalLayout {
                    spacing: VortexSpacing.sm;

                    // Token URL
                    VerticalLayout {
                        spacing: VortexSpacing.xs;

                        Text {
                            text: "Token URL";
                            color: VortexPalette.text-secondary;
                            font-size: VortexTypography.font-sm;
                        }

                        Rectangle {
                            height: 32px;
                            background: VortexPalette.bg-input;
                            border-radius: VortexShape.radius-sm;
                            border-width: 1px;
                            border-color: VortexPalette.border-default;

                            LineEdit {
                                text <=> oauth2-token-url;
                                placeholder-text: "https://auth.example.com/oauth/token";
                                font-size: VortexTypography.font-sm;
                                edited => {
                                    oauth2-client-credentials-changed(self.text, oauth2-client-id, oauth2-client-secret, oauth2-scope);
                                }
                            }
                        }
                    }

                    // Client ID and Client Secret row
                    HorizontalLayout {
                        spacing: VortexSpacing.md;

                        VerticalLayout {
                            horizontal-stretch: 1;
                            spacing: VortexSpacing.xs;

                            Text {
                                text: "Client ID";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-sm;
                            }

                            Rectangle {
                                height: 32px;
                                background: VortexPalette.bg-input;
                                border-radius: VortexShape.radius-sm;
                                border-width: 1px;
                                border-color: VortexPalette.border-default;

                                LineEdit {
                                    text <=> oauth2-client-id;
                                    placeholder-text: "Client ID or {{variable}}";
                                    font-size: VortexTypography.font-sm;
                                    edited => {
                                        oauth2-client-credentials-changed(oauth2-token-url, self.text, oauth2-client-secret, oauth2-scope);
                                    }
                                }
                            }
                        }

                        VerticalLayout {
                            horizontal-stretch: 1;
                            spacing: VortexSpacing.xs;

                            Text {
                                text: "Client Secret";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-sm;
                            }

                            Rectangle {
                                height: 32px;
                                background: VortexPalette.bg-input;
                                border-radius: VortexShape.radius-sm;
                                border-width: 1px;
                                border-color: VortexPalette.border-default;

                                LineEdit {
                                    text <=> oauth2-client-secret;
                                    placeholder-text: "Secret or {{variable}}";
                                    font-size: VortexTypography.font-sm;
                                    input-type: password;
                                    edited => {
                                        oauth2-client-credentials-changed(oauth2-token-url, oauth2-client-id, self.text, oauth2-scope);
                                    }
                                }
                            }
                        }
                    }

                    // Scope
                    VerticalLayout {
                        spacing: VortexSpacing.xs;

                        Text {
                            text: "Scope (optional)";
                            color: VortexPalette.text-secondary;
                            font-size: VortexTypography.font-sm;
                        }

                        Rectangle {
                            height: 32px;
                            background: VortexPalette.bg-input;
                            border-radius: VortexShape.radius-sm;
                            border-width: 1px;
                            border-color: VortexPalette.border-default;

                            LineEdit {
                                text <=> oauth2-scope;
                                placeholder-text: "read write (space-separated)";
                                font-size: VortexTypography.font-sm;
                                edited => {
                                    oauth2-client-credentials-changed(oauth2-token-url, oauth2-client-id, oauth2-client-secret, self.text);
                                }
                            }
                        }
                    }

                    // Token status and actions
                    HorizontalLayout {
                        spacing: VortexSpacing.md;
                        alignment: space-between;

                        // Token status
                        HorizontalLayout {
                            spacing: VortexSpacing.xs;

                            if oauth2-token-status == "valid": Rectangle {
                                width: 8px;
                                height: 8px;
                                border-radius: 4px;
                                background: VortexPalette.status-success;
                            }

                            if oauth2-token-status == "expired": Rectangle {
                                width: 8px;
                                height: 8px;
                                border-radius: 4px;
                                background: VortexPalette.status-warning;
                            }

                            if oauth2-token-status == "fetching": Rectangle {
                                width: 8px;
                                height: 8px;
                                border-radius: 4px;
                                background: VortexPalette.accent;
                            }

                            Text {
                                text: oauth2-token-status == "valid" ? "Token valid" :
                                      oauth2-token-status == "expired" ? "Token expired" :
                                      oauth2-token-status == "fetching" ? "Fetching..." : "No token";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-xs;
                                vertical-alignment: center;
                            }

                            if oauth2-token-preview != "": Text {
                                text: oauth2-token-preview;
                                color: VortexPalette.text-muted;
                                font-size: VortexTypography.font-xs;
                                vertical-alignment: center;
                            }
                        }

                        // Actions
                        HorizontalLayout {
                            spacing: VortexSpacing.sm;

                            Rectangle {
                                width: 90px;
                                height: 28px;
                                background: get-token-touch.has-hover ? VortexPalette.accent-hover : VortexPalette.accent;
                                border-radius: VortexShape.radius-sm;

                                Text {
                                    text: "Get Token";
                                    color: white;
                                    font-size: VortexTypography.font-xs;
                                    font-weight: VortexTypography.weight-bold;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }

                                get-token-touch := TouchArea {
                                    clicked => { oauth2-get-token(); }
                                }
                            }

                            if oauth2-token-status != "none" && oauth2-token-status != "": Rectangle {
                                width: 60px;
                                height: 28px;
                                background: clear-token-touch.has-hover ? VortexPalette.bg-hover : VortexPalette.bg-tertiary;
                                border-radius: VortexShape.radius-sm;
                                border-width: 1px;
                                border-color: VortexPalette.border-default;

                                Text {
                                    text: "Clear";
                                    color: VortexPalette.text-secondary;
                                    font-size: VortexTypography.font-xs;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }

                                clear-token-touch := TouchArea {
                                    clicked => { oauth2-clear-token(); }
                                }
                            }
                        }
                    }
                }

                // OAuth2 Authorization Code
                if auth-type == 5: VerticalLayout {
                    spacing: VortexSpacing.sm;

                    // Auth URL
                    VerticalLayout {
                        spacing: VortexSpacing.xs;

                        Text {
                            text: "Authorization URL";
                            color: VortexPalette.text-secondary;
                            font-size: VortexTypography.font-sm;
                        }

                        Rectangle {
                            height: 32px;
                            background: VortexPalette.bg-input;
                            border-radius: VortexShape.radius-sm;
                            border-width: 1px;
                            border-color: VortexPalette.border-default;

                            LineEdit {
                                text <=> oauth2-auth-url;
                                placeholder-text: "https://auth.example.com/authorize";
                                font-size: VortexTypography.font-sm;
                                edited => {
                                    oauth2-auth-code-changed(self.text, oauth2-token-url, oauth2-client-id, oauth2-client-secret, oauth2-redirect-uri, oauth2-scope);
                                }
                            }
                        }
                    }

                    // Token URL
                    VerticalLayout {
                        spacing: VortexSpacing.xs;

                        Text {
                            text: "Token URL";
                            color: VortexPalette.text-secondary;
                            font-size: VortexTypography.font-sm;
                        }

                        Rectangle {
                            height: 32px;
                            background: VortexPalette.bg-input;
                            border-radius: VortexShape.radius-sm;
                            border-width: 1px;
                            border-color: VortexPalette.border-default;

                            LineEdit {
                                text <=> oauth2-token-url;
                                placeholder-text: "https://auth.example.com/oauth/token";
                                font-size: VortexTypography.font-sm;
                                edited => {
                                    oauth2-auth-code-changed(oauth2-auth-url, self.text, oauth2-client-id, oauth2-client-secret, oauth2-redirect-uri, oauth2-scope);
                                }
                            }
                        }
                    }

                    // Client ID and Secret row
                    HorizontalLayout {
                        spacing: VortexSpacing.md;

                        VerticalLayout {
                            horizontal-stretch: 1;
                            spacing: VortexSpacing.xs;

                            Text {
                                text: "Client ID";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-sm;
                            }

                            Rectangle {
                                height: 32px;
                                background: VortexPalette.bg-input;
                                border-radius: VortexShape.radius-sm;
                                border-width: 1px;
                                border-color: VortexPalette.border-default;

                                LineEdit {
                                    text <=> oauth2-client-id;
                                    placeholder-text: "Client ID";
                                    font-size: VortexTypography.font-sm;
                                    edited => {
                                        oauth2-auth-code-changed(oauth2-auth-url, oauth2-token-url, self.text, oauth2-client-secret, oauth2-redirect-uri, oauth2-scope);
                                    }
                                }
                            }
                        }

                        VerticalLayout {
                            horizontal-stretch: 1;
                            spacing: VortexSpacing.xs;

                            Text {
                                text: "Client Secret";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-sm;
                            }

                            Rectangle {
                                height: 32px;
                                background: VortexPalette.bg-input;
                                border-radius: VortexShape.radius-sm;
                                border-width: 1px;
                                border-color: VortexPalette.border-default;

                                LineEdit {
                                    text <=> oauth2-client-secret;
                                    placeholder-text: "Secret";
                                    font-size: VortexTypography.font-sm;
                                    input-type: password;
                                    edited => {
                                        oauth2-auth-code-changed(oauth2-auth-url, oauth2-token-url, oauth2-client-id, self.text, oauth2-redirect-uri, oauth2-scope);
                                    }
                                }
                            }
                        }
                    }

                    // Redirect URI and Scope row
                    HorizontalLayout {
                        spacing: VortexSpacing.md;

                        VerticalLayout {
                            horizontal-stretch: 1;
                            spacing: VortexSpacing.xs;

                            Text {
                                text: "Callback URL";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-sm;
                            }

                            Rectangle {
                                height: 32px;
                                background: VortexPalette.bg-input;
                                border-radius: VortexShape.radius-sm;
                                border-width: 1px;
                                border-color: VortexPalette.border-default;

                                LineEdit {
                                    text <=> oauth2-redirect-uri;
                                    placeholder-text: "http://localhost:8080/callback";
                                    font-size: VortexTypography.font-sm;
                                    edited => {
                                        oauth2-auth-code-changed(oauth2-auth-url, oauth2-token-url, oauth2-client-id, oauth2-client-secret, self.text, oauth2-scope);
                                    }
                                }
                            }
                        }

                        VerticalLayout {
                            horizontal-stretch: 1;
                            spacing: VortexSpacing.xs;

                            Text {
                                text: "Scope (optional)";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-sm;
                            }

                            Rectangle {
                                height: 32px;
                                background: VortexPalette.bg-input;
                                border-radius: VortexShape.radius-sm;
                                border-width: 1px;
                                border-color: VortexPalette.border-default;

                                LineEdit {
                                    text <=> oauth2-scope;
                                    placeholder-text: "openid profile";
                                    font-size: VortexTypography.font-sm;
                                    edited => {
                                        oauth2-auth-code-changed(oauth2-auth-url, oauth2-token-url, oauth2-client-id, oauth2-client-secret, oauth2-redirect-uri, self.text);
                                    }
                                }
                            }
                        }
                    }

                    // Token status and actions
                    HorizontalLayout {
                        spacing: VortexSpacing.md;
                        alignment: space-between;

                        // Token status
                        HorizontalLayout {
                            spacing: VortexSpacing.xs;

                            if oauth2-token-status == "valid": Rectangle {
                                width: 8px;
                                height: 8px;
                                border-radius: 4px;
                                background: VortexPalette.status-success;
                            }

                            if oauth2-token-status == "expired": Rectangle {
                                width: 8px;
                                height: 8px;
                                border-radius: 4px;
                                background: VortexPalette.status-warning;
                            }

                            if oauth2-token-status == "fetching": Rectangle {
                                width: 8px;
                                height: 8px;
                                border-radius: 4px;
                                background: VortexPalette.accent;
                            }

                            Text {
                                text: oauth2-token-status == "valid" ? "Token valid" :
                                      oauth2-token-status == "expired" ? "Token expired" :
                                      oauth2-token-status == "fetching" ? "Authorizing..." : "No token";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-xs;
                                vertical-alignment: center;
                            }
                        }

                        // Actions
                        HorizontalLayout {
                            spacing: VortexSpacing.sm;

                            Rectangle {
                                width: 90px;
                                height: 28px;
                                background: auth-touch.has-hover ? VortexPalette.accent-hover : VortexPalette.accent;
                                border-radius: VortexShape.radius-sm;

                                Text {
                                    text: "Authorize";
                                    color: white;
                                    font-size: VortexTypography.font-xs;
                                    font-weight: VortexTypography.weight-bold;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }

                                auth-touch := TouchArea {
                                    clicked => { oauth2-get-token(); }
                                }
                            }

                            if oauth2-token-status != "none" && oauth2-token-status != "": Rectangle {
                                width: 60px;
                                height: 28px;
                                background: clear-auth-touch.has-hover ? VortexPalette.bg-hover : VortexPalette.bg-tertiary;
                                border-radius: VortexShape.radius-sm;
                                border-width: 1px;
                                border-color: VortexPalette.border-default;

                                Text {
                                    text: "Clear";
                                    color: VortexPalette.text-secondary;
                                    font-size: VortexTypography.font-xs;
                                    horizontal-alignment: center;
                                    vertical-alignment: center;
                                }

                                clear-auth-touch := TouchArea {
                                    clicked => { oauth2-clear-token(); }
                                }
                            }
                        }
                    }
                }
            }
        }

        // No auth message
        if !collapsed && auth-type == 0: Rectangle {
            height: 50px;
            background: VortexPalette.bg-tertiary;

            Text {
                text: "This request does not use any authorization.";
                color: VortexPalette.text-placeholder;
                font-size: VortexTypography.font-sm;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }
    }
}
