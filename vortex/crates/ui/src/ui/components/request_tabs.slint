// Request Tabs Component
// Postman-style tabs with method badges and environment selector

import { ScrollView, ComboBox } from "std-widgets.slint";
import { VortexPalette, VortexTypography, VortexSpacing, VortexShape, VortexLayout } from "../theme.slint";

// Represents an open request tab
export struct RequestTab {
    id: string,
    name: string,
    method: string,
    has-unsaved-changes: bool,
}

// Individual tab component - Postman style
component TabItem inherits Rectangle {
    in property <RequestTab> tab;
    in property <bool> is-active: false;

    callback clicked();
    callback close-clicked();

    // Reasonable size constraints for tabs
    min-width: 120px;
    max-width: 220px;
    height: VortexLayout.tab-height;

    // Rounded top corners only for active tab
    background: is-active ? VortexPalette.bg-primary : transparent;
    border-radius: is-active ? VortexShape.radius-sm : 0px;

    // Top border indicator (orange for active)
    Rectangle {
        x: 0;
        y: 0;
        width: parent.width;
        height: 2px;
        background: is-active ? VortexPalette.accent : transparent;
    }

    // Right border separator
    Rectangle {
        x: parent.width - 1px;
        y: 4px;
        width: 1px;
        height: parent.height - 8px;
        background: VortexPalette.border-default;
    }

    states [
        hover when tab-touch.has-hover && !is-active: {
            background: VortexPalette.bg-hover;
        }
    ]

    tab-touch := TouchArea {
        clicked => { root.clicked(); }
    }

    HorizontalLayout {
        padding-left: VortexSpacing.md;
        padding-right: VortexSpacing.xs;
        spacing: VortexSpacing.sm;
        alignment: start;

        // Method badge - colored text only (Postman style)
        Text {
            text: tab.method;
            font-size: VortexTypography.font-xxs;
            font-weight: VortexTypography.weight-bold;
            color: tab.method == "GET" ? VortexPalette.method-get :
                   tab.method == "POST" ? VortexPalette.method-post :
                   tab.method == "PUT" ? VortexPalette.method-put :
                   tab.method == "PATCH" ? VortexPalette.method-patch :
                   tab.method == "DELETE" ? VortexPalette.method-delete :
                   tab.method == "HEAD" ? VortexPalette.method-head :
                   VortexPalette.method-options;
            vertical-alignment: center;
        }

        // Tab name
        Text {
            text: tab.name == "" ? "Untitled Request" : tab.name;
            font-size: VortexTypography.font-sm;
            color: is-active ? VortexPalette.text-primary : VortexPalette.text-secondary;
            overflow: elide;
            vertical-alignment: center;
            horizontal-stretch: 1;
        }

        // Dirty indicator / Close button container
        Rectangle {
            width: 20px;
            height: 20px;
            background: close-touch.has-hover ? VortexPalette.bg-hover : transparent;
            border-radius: VortexShape.radius-sm;

            // Dirty indicator (shows when inactive and has unsaved changes)
            if tab.has-unsaved-changes && !is-active && !close-touch.has-hover: Rectangle {
                width: 6px;
                height: 6px;
                border-radius: VortexShape.radius-full;
                background: VortexPalette.accent;
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
            }

            // Close X (shows on active tab or hover)
            if is-active || close-touch.has-hover || !tab.has-unsaved-changes: Text {
                text: "x";  // X mark
                font-size: VortexTypography.font-sm;
                color: close-touch.has-hover ? VortexPalette.text-primary : VortexPalette.text-muted;
                horizontal-alignment: center;
                vertical-alignment: center;
            }

            close-touch := TouchArea {
                clicked => { root.close-clicked(); }
            }
        }
    }
}

// Environment selector component - uses ComboBox for actual selection
component EnvironmentSelector inherits Rectangle {
    in property <[string]> environments: ["No Environment"];
    in-out property <int> selected-index: 0;

    callback environment-changed(int);
    callback quick-look-clicked();

    height: 28px;

    HorizontalLayout {
        spacing: VortexSpacing.xs;

        // Dropdown selector using ComboBox
        ComboBox {
            width: 140px;
            height: 28px;
            model: environments;
            current-index <=> selected-index;

            selected(value) => {
                environment-changed(self.current-index);
            }
        }

        // Manage environments button (gear icon)
        Rectangle {
            width: 28px;
            height: 28px;
            background: gear-touch.has-hover ? VortexPalette.bg-hover : transparent;
            border-radius: VortexShape.radius-sm;

            Text {
                text: "\u{2699}";  // Gear icon
                font-size: VortexTypography.font-lg;
                color: gear-touch.has-hover ? VortexPalette.text-primary : VortexPalette.text-muted;
                horizontal-alignment: center;
                vertical-alignment: center;
            }

            gear-touch := TouchArea {
                clicked => { quick-look-clicked(); }
            }
        }
    }
}

// Main Tab bar component
export component RequestTabBar inherits Rectangle {
    in property <[RequestTab]> tabs: [];
    in property <string> active-tab-id: "";
    in property <[string]> environments: ["No Environment"];
    in-out property <int> selected-environment-index: 0;

    callback tab-clicked(string /* id */);
    callback tab-close-clicked(string /* id */);
    callback new-tab-clicked();
    callback environment-changed(int);
    callback quick-look-environments();

    height: VortexLayout.tab-bar-height;
    background: VortexPalette.bg-secondary;

    // Bottom border
    Rectangle {
        x: 0;
        y: parent.height - 1px;
        width: parent.width;
        height: 1px;
        background: VortexPalette.border-default;
    }

    HorizontalLayout {
        alignment: space-between;

        // Left side: Tabs + New button
        Rectangle {
            horizontal-stretch: 1;
            clip: true;

            HorizontalLayout {
                padding-top: VortexSpacing.xs;
                padding-left: VortexSpacing.xs;
                spacing: VortexSpacing.xs;
                alignment: start;

                // Tabs - no ScrollView, just overflow hidden
                for tab in tabs: TabItem {
                    tab: tab;
                    is-active: tab.id == active-tab-id;

                    clicked => { root.tab-clicked(tab.id); }
                    close-clicked => { root.tab-close-clicked(tab.id); }
                }

                // New tab button
                Rectangle {
                    width: 32px;
                    height: VortexLayout.tab-height;
                    background: new-tab-touch.has-hover ? VortexPalette.bg-hover : transparent;
                    border-radius: VortexShape.radius-sm;

                    Text {
                        text: "+";
                        font-size: VortexTypography.font-lg;
                        color: new-tab-touch.has-hover ? VortexPalette.text-primary : VortexPalette.text-muted;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    new-tab-touch := TouchArea {
                        clicked => { new-tab-clicked(); }
                    }
                }
            }
        }

        // Right side: Environment selector
        HorizontalLayout {
            width: 200px;
            padding-right: VortexSpacing.sm;
            alignment: center;

            EnvironmentSelector {
                environments: root.environments;
                selected-index <=> root.selected-environment-index;
                environment-changed(idx) => { root.environment-changed(idx); }
                quick-look-clicked => { root.quick-look-environments(); }
            }
        }
    }
}
