// Collection tree view for navigating requests and folders.

import { Button, VerticalBox, HorizontalBox, ScrollView } from "std-widgets.slint";
import { VortexPalette, VortexTypography, VortexSpacing, VortexShape } from "../theme.slint";

// Represents an item in the collection tree (request or folder)
export struct TreeItem {
    id: string,
    name: string,
    item-type: string,  // "request", "folder", "collection"
    method: string,     // HTTP method for requests, empty for folders
    depth: int,         // Nesting level for indentation
    expanded: bool,     // For folders: whether children are visible
    path: string,       // File path
}

export component TreeItemRow inherits Rectangle {
    in property <TreeItem> item;
    in property <bool> selected: false;

    callback clicked();
    callback double-clicked();
    callback toggle-expanded();
    callback context-menu(/* x */ length, /* y */ length);

    min-height: 36px;
    background: selected ? VortexPalette.bg-selected : transparent;
    border-radius: VortexShape.radius-sm;

    states [
        hover when touch.has-hover && !selected: {
            background: VortexPalette.bg-hover;
        }
    ]

    touch := TouchArea {
        clicked => { root.clicked(); }
        double-clicked => { root.double-clicked(); }
        pointer-event(event) => {
            if event.button == PointerEventButton.right {
                root.context-menu(self.mouse-x, self.mouse-y);
            }
        }
    }

    HorizontalBox {
        padding-left: (item.depth * 16px) + VortexSpacing.sm;
        padding-right: VortexSpacing.sm;
        spacing: VortexSpacing.sm;
        alignment: start;

        // Expand/collapse button for folders
        if item.item-type == "folder" || item.item-type == "collection": Rectangle {
            width: 20px;
            height: 20px;

            Text {
                text: item.expanded ? "\u{25BC}" : "\u{25B6}"; // Down/right triangle
                font-size: VortexTypography.font-xs;
                color: VortexPalette.text-secondary;
                horizontal-alignment: center;
                vertical-alignment: center;
            }

            TouchArea {
                clicked => { root.toggle-expanded(); }
            }
        }

        // Method badge for requests
        if item.item-type == "request": Rectangle {
            width: 48px;
            height: 22px;
            border-radius: VortexShape.radius-sm;
            background: item.method == "GET" ? VortexPalette.method-get :
                       item.method == "POST" ? VortexPalette.method-post :
                       item.method == "PUT" ? VortexPalette.method-put :
                       item.method == "PATCH" ? VortexPalette.method-patch :
                       item.method == "DELETE" ? VortexPalette.method-delete :
                       item.method == "HEAD" ? VortexPalette.method-head :
                       item.method == "OPTIONS" ? VortexPalette.method-options :
                       VortexPalette.outline;

            Text {
                text: item.method;
                font-size: VortexTypography.font-xs;
                font-weight: VortexTypography.weight-bold;
                color: white;
                horizontal-alignment: center;
                vertical-alignment: center;
            }
        }

        // Folder icon
        if item.item-type == "folder": Text {
            text: "\u{25A1}"; // White square (folder representation)
            font-size: VortexTypography.font-base;
            color: VortexPalette.status-warning;
            vertical-alignment: center;
        }

        // Collection icon
        if item.item-type == "collection": Text {
            text: "\u{25C6}"; // Diamond (collection representation)
            font-size: VortexTypography.font-base;
            color: VortexPalette.primary;
            vertical-alignment: center;
        }

        // Item name
        Text {
            text: item.name;
            font-size: VortexTypography.font-sm;
            color: selected ? VortexPalette.on-primary-container : VortexPalette.text-primary;
            overflow: elide;
            vertical-alignment: center;
        }
    }
}

export component CollectionTreeView inherits Rectangle {
    in property <[TreeItem]> items;
    in-out property <string> selected-id;

    callback item-selected(TreeItem);
    callback item-double-clicked(TreeItem);
    callback toggle-folder(TreeItem);
    callback create-request(TreeItem /* parent */);
    callback create-folder(TreeItem /* parent */);
    callback delete-item(TreeItem);
    callback rename-item(TreeItem);

    ScrollView {
        VerticalBox {
            alignment: start;
            spacing: 2px;
            padding: VortexSpacing.xs;

            for item in items: TreeItemRow {
                item: item;
                selected: item.id == selected-id;
                clicked => {
                    selected-id = item.id;
                    root.item-selected(item);
                }
                double-clicked => {
                    root.item-double-clicked(item);
                }
                toggle-expanded => {
                    root.toggle-folder(item);
                }
            }
        }
    }
}
