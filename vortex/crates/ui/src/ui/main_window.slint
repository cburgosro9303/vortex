// Vortex API Client - Main Window
// Sprint 01: MVP Request Execution + Base UI
// Sprint 02: Persistence and Collections
// Sprint 03: Environments and Variables
// Sprint 04: Settings and Theme
// Sprint 05: Headers, Query Params, Auth, Response Tabs, Collection Management
// Sprint 06: Tabs, Quick Search, Import/Export, Keyboard Shortcuts

import { VerticalBox, HorizontalBox, TextEdit, ScrollView, LineEdit, Button, ComboBox } from "std-widgets.slint";
import { VortexPalette, VortexTypography, VortexSpacing, VortexShape, VortexLayout, VortexAnimation } from "theme.slint";
export { VortexPalette, VortexTypography, VortexSpacing, VortexShape, VortexLayout, VortexAnimation }
import { UrlBar } from "components/url_bar.slint";
import { ResponsePanel, ResponseHeader } from "components/response_panel.slint";
import { TreeItem, CollectionTreeView } from "components/collection_tree.slint";
import { WorkspaceSelector } from "components/file_dialog.slint";
import { CollectionToolbar } from "components/save_open_buttons.slint";
import { EnvironmentSelector } from "components/environment_selector.slint";
import { EnvironmentManager, EnvironmentInfo } from "components/environment_manager.slint";
import { VariableRow } from "components/variables_editor.slint";
import { SettingsDialog } from "components/settings_dialog.slint";
import { HistoryPanel, HistoryItem } from "components/history_panel.slint";
// Sprint 05 imports
import { QueryParamsEditor, QueryParam } from "components/query_params_editor.slint";
import { HeadersEditor, HeaderRow } from "components/headers_editor.slint";
import { AuthEditor } from "components/auth_editor.slint";
import { ConfirmDialog } from "components/confirm_dialog.slint";
// Sprint 06 imports
import { RequestTabBar, RequestTab } from "components/request_tabs.slint";
import { QuickSearchDialog, SearchResult } from "components/quick_search.slint";
import { RequestEditor } from "components/request_editor.slint";

export { HistoryItem, ResponseHeader, QueryParam, HeaderRow, RequestTab, SearchResult }

export { EnvironmentInfo, VariableRow }

export component MainWindow inherits Window {
    title: "Vortex API Client";
    min-width: 800px;
    min-height: 600px;
    preferred-width: 1200px;
    preferred-height: 800px;
    background: VortexPalette.bg-primary;

    // Request state
    in-out property <string> url: "";
    in-out property <int> method-index: 0;
    in-out property <string> request-body: "";

    // Response state (0=Idle, 1=Loading, 2=Success, 3=Error)
    in-out property <int> response-state: 0;

    // Response data
    in-out property <int> status-code: 0;
    in-out property <string> status-text: "";
    in-out property <string> response-body: "";
    in-out property <string> duration: "";
    in-out property <string> size: "";

    // Error data
    in-out property <string> error-title: "";
    in-out property <string> error-message: "";
    in-out property <[string]> error-suggestions: [];

    // Loading data
    in-out property <string> elapsed-time: "0ms";

    // Helper to check if method needs body
    property <bool> show-body-editor: method-index == 1 || method-index == 2 || method-index == 3;

    // Callbacks to Rust
    callback send-request();
    callback cancel-request();
    callback copy-response-body();

    // Collection/Workspace callbacks (Sprint 02)
    callback open-workspace();
    callback create-workspace();
    callback close-workspace();
    callback item-selected(TreeItem);
    callback item-double-clicked(TreeItem);
    callback toggle-folder(TreeItem);
    callback new-request-clicked();
    callback new-folder-clicked();
    callback save-collection();

    // Collection/Workspace state (Sprint 02)
    in-out property <string> workspace-path: "";
    in-out property <[TreeItem]> collection-items: [];
    in-out property <string> selected-item-id: "";
    in-out property <string> current-collection-name: "";
    in-out property <bool> has-unsaved-changes: false;
    in-out property <bool> is-saving: false;

    // Environment state (Sprint 03)
    in-out property <[string]> environment-names: [];
    in-out property <int> current-environment-index: 0;
    in-out property <string> current-environment-name: "No Environment";
    in-out property <string> resolved-url: "";
    in-out property <bool> has-unresolved-variables: false;
    in-out property <[string]> unresolved-variables: [];
    in-out property <bool> show-environment-manager: false;
    in-out property <[EnvironmentInfo]> environment-list: [];
    in-out property <int> env-manager-selected-index: -1;
    in-out property <string> env-manager-selected-name: "";
    in-out property <[VariableRow]> env-manager-variables: [];

    // Environment callbacks (Sprint 03)
    callback environment-changed(int);
    callback manage-environments-clicked();
    callback create-environment(string);
    callback delete-environment(int);
    callback select-env-for-editing(int);
    callback save-environment();
    callback add-env-variable();
    callback delete-env-variable(int);
    callback env-variable-changed(int, VariableRow);
    callback url-changed(string);

    // Settings state (Sprint 04)
    in-out property <bool> show-settings: false;
    in-out property <int> theme-mode-index: 1;  // 0=Light, 1=Dark, 2=System
    in-out property <int> font-scale-index: 1;  // 0=Small, 1=Medium, 2=Large

    // Settings callbacks (Sprint 04)
    callback toggle-theme();
    callback open-settings();
    callback close-settings();
    callback theme-mode-changed(int);
    callback font-scale-changed(int);

    // History state (Sprint 04)
    in-out property <[HistoryItem]> history-items: [];
    in-out property <bool> history-visible: true;
    in-out property <string> history-selected-id: "";

    // History callbacks (Sprint 04)
    callback history-item-clicked(HistoryItem);
    callback clear-history();
    callback toggle-history-visibility();

    // Sprint 05: Query Parameters state
    in-out property <[QueryParam]> query-params: [];
    in-out property <bool> query-params-collapsed: true;

    // Sprint 05: Query Parameters callbacks
    callback add-query-param();
    callback delete-query-param(int);
    callback query-param-changed(int, QueryParam);

    // Sprint 05: Request Headers state
    in-out property <[HeaderRow]> request-headers: [];
    in-out property <bool> headers-collapsed: true;

    // Sprint 05: Request Headers callbacks
    callback add-request-header();
    callback delete-request-header(int);
    callback request-header-changed(int, HeaderRow);

    // Sprint 05: Authentication state
    in-out property <int> auth-type: 0;  // 0=None, 1=Bearer, 2=Basic, 3=API Key
    in-out property <string> auth-bearer-token: "";
    in-out property <string> auth-basic-username: "";
    in-out property <string> auth-basic-password: "";
    in-out property <string> auth-api-key-name: "";
    in-out property <string> auth-api-key-value: "";
    in-out property <int> auth-api-key-location: 0;  // 0=Header, 1=Query
    in-out property <bool> auth-collapsed: true;

    // Sprint 05: Authentication callbacks
    callback auth-type-changed(int);
    callback auth-bearer-token-changed(string);
    callback auth-basic-credentials-changed(string, string);
    callback auth-api-key-changed(string, string, int);

    // Sprint 05: Response Headers state
    in-out property <[ResponseHeader]> response-headers: [];

    // Sprint 05: Collection management state
    in-out property <bool> show-confirm-dialog: false;
    in-out property <string> confirm-dialog-title: "";
    in-out property <string> confirm-dialog-message: "";
    in-out property <string> pending-delete-id: "";
    in-out property <string> pending-delete-type: "";  // "request" or "collection"

    // Sprint 05: Collection management callbacks
    callback save-current-request();
    callback rename-item(string, string);  // id, new_name
    callback delete-item-requested(string, string);  // id, type
    callback confirm-delete();
    callback cancel-delete();

    // Sprint 06: Request Tabs state
    in-out property <[RequestTab]> request-tabs: [];
    in-out property <string> active-tab-id: "";

    // Sprint 06: Request Tabs callbacks
    callback tab-clicked(string);
    callback tab-close-clicked(string);
    callback new-tab-clicked();

    // Sprint 06: Quick Search state
    in-out property <bool> show-quick-search: false;
    in-out property <string> search-query: "";
    in-out property <[SearchResult]> search-results: [];
    in-out property <int> search-selected-index: 0;

    // Sprint 06: Quick Search callbacks
    callback open-quick-search();
    callback close-quick-search();
    callback search-query-changed(string);
    callback search-result-clicked(SearchResult);

    // Sprint 06: Import/Export callbacks
    callback import-collection();
    callback import-environment();
    callback export-collection();
    callback export-as-curl();

    // Sprint 06: JSON Format callbacks
    callback format-response-body();
    callback format-request-body();
    callback copy-formatted-response();

    // Sprint 06: Global keyboard shortcuts handler
    FocusScope {
        enabled: !show-quick-search && !show-settings && !show-confirm-dialog && !show-environment-manager;

        key-pressed(event) => {
            // Check for Cmd/Ctrl modifier (Meta on macOS, Control on others)
            if (event.modifiers.meta || event.modifiers.control) {
                // Cmd/Ctrl + Enter: Send request
                if (event.text == Key.Return) {
                    send-request();
                    return accept;
                }
                // Cmd/Ctrl + S: Save current request
                if (event.text == "s" || event.text == "S") {
                    save-current-request();
                    return accept;
                }
                // Cmd/Ctrl + K: Open quick search
                if (event.text == "k" || event.text == "K") {
                    open-quick-search();
                    show-quick-search = true;
                    return accept;
                }
                // Cmd/Ctrl + W: Close current tab
                if (event.text == "w" || event.text == "W") {
                    if active-tab-id != "" {
                        tab-close-clicked(active-tab-id);
                    }
                    return accept;
                }
                // Cmd/Ctrl + T: New tab
                if (event.text == "t" || event.text == "T") {
                    new-tab-clicked();
                    return accept;
                }
            }
            return reject;
        }
    }

    VerticalLayout {
        spacing: 0;

        // Title bar - fixed height (Postman style)
        Rectangle {
            height: VortexLayout.header-height;
            background: VortexPalette.bg-secondary;
            border-width: 1px;
            border-color: VortexPalette.border-default;

            HorizontalLayout {
                padding-left: VortexSpacing.md;
                padding-right: VortexSpacing.md;

                Text {
                    text: "Vortex";
                    color: VortexPalette.text-primary;
                    font-size: VortexTypography.font-lg;
                    font-weight: VortexTypography.weight-bold;
                    vertical-alignment: center;
                }

                Rectangle { horizontal-stretch: 1; }

                // Theme toggle button
                Rectangle {
                    width: 32px;
                    height: 28px;
                    background: VortexPalette.bg-tertiary;
                    border-radius: VortexShape.radius-sm;

                    states [
                        hover when theme-toggle-touch.has-hover: {
                            background: VortexPalette.bg-hover;
                        }
                    ]

                    Text {
                        text: VortexPalette.dark-mode ? "\u{263E}" : "\u{2600}"; // Moon or Sun
                        color: VortexPalette.text-secondary;
                        font-size: VortexTypography.font-lg;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    theme-toggle-touch := TouchArea {
                        clicked => {
                            toggle-theme();
                        }
                    }
                }

                Rectangle { width: VortexSpacing.xs; }

                // Settings button
                Rectangle {
                    width: 32px;
                    height: 28px;
                    background: VortexPalette.bg-tertiary;
                    border-radius: VortexShape.radius-sm;

                    states [
                        hover when settings-touch.has-hover: {
                            background: VortexPalette.bg-hover;
                        }
                    ]

                    Text {
                        text: "\u{2699}"; // Gear icon
                        color: VortexPalette.text-secondary;
                        font-size: VortexTypography.font-lg;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }

                    settings-touch := TouchArea {
                        clicked => {
                            open-settings();
                        }
                    }
                }

                Rectangle { width: VortexSpacing.sm; }

                Text {
                    text: "v0.1.0";
                    color: VortexPalette.text-secondary;
                    font-size: VortexTypography.font-sm;
                    vertical-alignment: center;
                }
            }
        }

        // Main content area - fills remaining space
        HorizontalLayout {
            vertical-stretch: 1;
            spacing: 0;

            // Sidebar with collections - fixed width (Postman style)
            Rectangle {
                width: VortexLayout.sidebar-width;
                background: VortexPalette.bg-secondary;
                border-width: 1px;
                border-color: VortexPalette.border-default;

                VerticalLayout {
                    spacing: 0;

                    // Workspace selector
                    Rectangle {
                        height: workspace-path == "" ? 100px : 80px;
                        background: VortexPalette.bg-tertiary;

                        VerticalLayout {
                            padding: VortexSpacing.sm;
                            spacing: VortexSpacing.xs;

                            Text {
                                text: workspace-path == "" ? "No Workspace" : "Workspace";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-xs;
                                font-weight: VortexTypography.weight-bold;
                            }

                            if workspace-path != "": Text {
                                text: workspace-path;
                                color: VortexPalette.text-primary;
                                font-size: VortexTypography.font-sm;
                                overflow: elide;
                            }

                            HorizontalLayout {
                                spacing: VortexSpacing.xs;

                                Button {
                                    text: "Open";
                                    clicked => { open-workspace(); }
                                }

                                Button {
                                    text: "New";
                                    clicked => { create-workspace(); }
                                }

                                if workspace-path != "": Button {
                                    text: "Close";
                                    clicked => { close-workspace(); }
                                }
                            }
                        }
                    }

                    // Collections header
                    Rectangle {
                        height: 40px;
                        background: VortexPalette.bg-secondary;

                        HorizontalLayout {
                            padding-left: VortexSpacing.md;
                            padding-right: VortexSpacing.sm;
                            alignment: space-between;

                            Text {
                                text: "COLLECTIONS";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-xs;
                                font-weight: VortexTypography.weight-bold;
                                letter-spacing: 0.5px;
                                vertical-alignment: center;
                            }

                            HorizontalLayout {
                                spacing: VortexSpacing.xs;

                                // Import button
                                Rectangle {
                                    width: 50px;
                                    height: 24px;
                                    background: import-touch.has-hover ? VortexPalette.bg-hover : transparent;
                                    border-radius: VortexShape.radius-sm;

                                    Text {
                                        text: "Import";
                                        font-size: VortexTypography.font-xs;
                                        color: workspace-path != "" ? VortexPalette.text-secondary : VortexPalette.text-placeholder;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                    }

                                    import-touch := TouchArea {
                                        enabled: workspace-path != "";
                                        clicked => { import-collection(); }
                                    }
                                }

                                // Export button
                                Rectangle {
                                    width: 50px;
                                    height: 24px;
                                    background: export-touch.has-hover ? VortexPalette.bg-hover : transparent;
                                    border-radius: VortexShape.radius-sm;

                                    Text {
                                        text: "Export";
                                        font-size: VortexTypography.font-xs;
                                        color: workspace-path != "" ? VortexPalette.text-secondary : VortexPalette.text-placeholder;
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                    }

                                    export-touch := TouchArea {
                                        enabled: workspace-path != "";
                                        clicked => { export-collection(); }
                                    }
                                }

                                Button {
                                    text: "+";
                                    enabled: workspace-path != "";
                                    clicked => { new-request-clicked(); }
                                }
                            }
                        }
                    }

                    // Collection tree
                    if collection-items.length > 0: CollectionTreeView {
                        vertical-stretch: 1;
                        items: collection-items;
                        selected-id <=> selected-item-id;

                        item-selected(item) => { root.item-selected(item); }
                        item-double-clicked(item) => { root.item-double-clicked(item); }
                        toggle-folder(item) => { root.toggle-folder(item); }
                    }

                    // Empty state
                    if collection-items.length == 0: Rectangle {
                        vertical-stretch: 1;

                        Text {
                            text: workspace-path == "" ?
                                "Open or create a workspace\nto see collections" :
                                "No collections yet\n\nCreate a new collection\nto get started";
                            color: VortexPalette.text-placeholder;
                            font-size: VortexTypography.font-sm;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    // History panel
                    HistoryPanel {
                        items: history-items;
                        is-visible: history-visible;
                        selected-id: history-selected-id;

                        item-clicked(item) => { history-item-clicked(item); }
                        clear-history => { root.clear-history(); }
                        toggle-visibility => { history-visible = !history-visible; }
                    }

                    // Save indicator
                    if has-unsaved-changes: Rectangle {
                        height: 32px;
                        background: VortexPalette.dark-mode ? #4a3000 : #fff3e0;

                        HorizontalLayout {
                            padding: VortexSpacing.sm;
                            alignment: space-between;

                            Text {
                                text: "Unsaved changes";
                                color: VortexPalette.dark-mode ? #fdd663 : #e65100;
                                font-size: VortexTypography.font-sm;
                                vertical-alignment: center;
                            }

                            Button {
                                text: is-saving ? "Saving..." : "Save";
                                enabled: !is-saving;
                                clicked => { save-collection(); }
                            }
                        }
                    }
                }
            }

            // Main editor area - fills remaining width
            Rectangle {
                horizontal-stretch: 1;
                background: VortexPalette.bg-primary;

                VerticalLayout {
                    spacing: 0;

                    // Sprint 06: Request Tabs Bar with Environment Selector
                    RequestTabBar {
                        tabs: request-tabs;
                        active-tab-id: root.active-tab-id;
                        environments: root.environment-names.length > 0 ? root.environment-names : ["No Environment"];
                        selected-environment-index <=> root.current-environment-index;

                        tab-clicked(id) => { root.tab-clicked(id); }
                        tab-close-clicked(id) => { root.tab-close-clicked(id); }
                        new-tab-clicked => { root.new-tab-clicked(); }
                        environment-changed(idx) => { root.environment-changed(idx); }
                        quick-look-environments => { root.manage-environments-clicked(); }
                    }

                    // URL Bar with variable preview
                    Rectangle {
                        height: has-unresolved-variables || (resolved-url != url && resolved-url != "") ? 72px : VortexLayout.url-bar-height;
                        background: VortexPalette.bg-secondary;

                        VerticalLayout {
                            spacing: 2px;

                            // Main URL bar
                            UrlBar {
                                url <=> root.url;
                                method-index <=> root.method-index;
                                is-loading: response-state == 1;

                                send-clicked => { send-request(); }
                                cancel-clicked => { cancel-request(); }
                                url-changed(new-url) => { root.url-changed(new-url); }
                            }

                            // Resolved URL preview
                            if resolved-url != url && resolved-url != "": Rectangle {
                                height: 24px;
                                background: VortexPalette.bg-tertiary;

                                HorizontalLayout {
                                    padding-left: VortexSpacing.sm;
                                    padding-right: VortexSpacing.sm;
                                    spacing: VortexSpacing.sm;

                                    Text {
                                        text: has-unresolved-variables ? "\u{26A0}" : "\u{2192}"; // Warning or arrow
                                        color: has-unresolved-variables ? VortexPalette.status-warning : VortexPalette.text-secondary;
                                        font-size: VortexTypography.font-sm;
                                        vertical-alignment: center;
                                    }

                                    Text {
                                        text: resolved-url;
                                        color: has-unresolved-variables ? VortexPalette.status-warning : VortexPalette.text-secondary;
                                        font-size: VortexTypography.font-sm;
                                        overflow: elide;
                                        vertical-alignment: center;
                                        horizontal-stretch: 1;
                                    }

                                    if has-unresolved-variables: Text {
                                        text: "(" + unresolved-variables.length + " unresolved)";
                                        color: VortexPalette.status-warning;
                                        font-size: VortexTypography.font-xs;
                                        vertical-alignment: center;
                                    }
                                }
                            }
                        }
                    }

                    // Request Editor with Tabs (Postman style)
                    RequestEditor {
                        height: 280px;

                        // Query params
                        params <=> query-params;

                        // Headers
                        headers <=> request-headers;

                        // Auth
                        auth-type <=> root.auth-type;
                        bearer-token <=> auth-bearer-token;
                        basic-username <=> auth-basic-username;
                        basic-password <=> auth-basic-password;
                        api-key-name <=> auth-api-key-name;
                        api-key-value <=> auth-api-key-value;
                        api-key-location <=> auth-api-key-location;

                        // Body - use raw mode for JSON
                        body-type: show-body-editor ? 2 : 0;  // 2 = raw when method supports body
                        body-raw <=> request-body;

                        // Query params callbacks
                        add-param => { add-query-param(); }
                        delete-param(idx) => { delete-query-param(idx); }
                        param-changed(idx, p) => { query-param-changed(idx, p); }

                        // Headers callbacks
                        add-header => { add-request-header(); }
                        delete-header(idx) => { delete-request-header(idx); }
                        header-changed(idx, h) => { request-header-changed(idx, h); }

                        // Auth callbacks
                        auth-type-changed(t) => { auth-type-changed(t); }
                        bearer-token-changed(t) => { auth-bearer-token-changed(t); }
                        basic-credentials-changed(u, p) => { auth-basic-credentials-changed(u, p); }
                        api-key-changed(k, v, l) => { auth-api-key-changed(k, v, l); }

                        // Body callbacks
                        body-raw-changed(body) => { /* body already bound via <=> */ }
                        format-body => { format-request-body(); }
                    }

                    // Response panel - fills remaining vertical space
                    ResponsePanel {
                        vertical-stretch: 1;
                        state: response-state;
                        status-code: root.status-code;
                        status-text: root.status-text;
                        response-body: root.response-body;
                        duration: root.duration;
                        size: root.size;
                        response-headers: root.response-headers;
                        error-title: root.error-title;
                        error-message: root.error-message;
                        error-suggestions: root.error-suggestions;
                        elapsed-time: root.elapsed-time;

                        retry-clicked => { send-request(); }
                        copy-body-clicked => { copy-response-body(); }
                        // Sprint 06: Format callbacks
                        format-body-clicked => { format-response-body(); }
                        copy-formatted-clicked => { copy-formatted-response(); }
                    }
                }
            }
        }
    }

    // Environment Manager Dialog (overlay)
    EnvironmentManager {
        is-visible: show-environment-manager;
        environments: environment-list;
        selected-index: env-manager-selected-index;
        selected-name: env-manager-selected-name;
        selected-variables: env-manager-variables;

        close-clicked => { show-environment-manager = false; }
        create-environment(name) => { create-environment(name); }
        delete-environment(idx) => { delete-environment(idx); }
        select-environment(idx) => { select-env-for-editing(idx); }
        save-environment => { save-environment(); }
        add-variable => { add-env-variable(); }
        delete-variable(idx) => { delete-env-variable(idx); }
        variable-changed(idx, var) => { env-variable-changed(idx, var); }
        import-clicked => { import-environment(); }
    }

    // Settings Dialog (overlay)
    SettingsDialog {
        is-visible: show-settings;
        theme-index: theme-mode-index;
        font-scale-index: font-scale-index;

        close-clicked => { show-settings = false; }
        theme-changed(idx) => {
            theme-mode-index = idx;
            theme-mode-changed(idx);
        }
        font-scale-changed(idx) => {
            font-scale-index = idx;
            font-scale-changed(idx);
        }
    }

    // Sprint 05: Confirm Dialog (overlay)
    ConfirmDialog {
        is-visible: show-confirm-dialog;
        title: confirm-dialog-title;
        message: confirm-dialog-message;
        confirm-text: "Delete";
        cancel-text: "Cancel";
        is-destructive: true;

        confirmed => {
            confirm-delete();
            show-confirm-dialog = false;
        }
        cancelled => {
            cancel-delete();
            show-confirm-dialog = false;
        }
    }

    // Sprint 06: Quick Search Dialog (overlay)
    QuickSearchDialog {
        is-visible: show-quick-search;
        search-query <=> root.search-query;
        results: search-results;
        selected-index: search-selected-index;

        search-changed(query) => {
            search-query-changed(query);
        }
        result-clicked(result) => {
            search-result-clicked(result);
            show-quick-search = false;
        }
        close-clicked => {
            close-quick-search();
            show-quick-search = false;
        }
    }
}
