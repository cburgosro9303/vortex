// Vortex API Client - Main Window
// Sprint 01: MVP Request Execution + Base UI
// Sprint 02: Persistence and Collections

import { VerticalBox, HorizontalBox, TextEdit, ScrollView, LineEdit, Button } from "std-widgets.slint";
import { VortexPalette, VortexTypography, VortexSpacing } from "theme.slint";
import { UrlBar } from "components/url_bar.slint";
import { ResponsePanel } from "components/response_panel.slint";
import { TreeItem, CollectionTreeView } from "components/collection_tree.slint";
import { WorkspaceSelector } from "components/file_dialog.slint";
import { CollectionToolbar } from "components/save_open_buttons.slint";

export component MainWindow inherits Window {
    title: "Vortex API Client";
    min-width: 800px;
    min-height: 600px;
    preferred-width: 1200px;
    preferred-height: 800px;
    background: VortexPalette.bg-primary;

    // Request state
    in-out property <string> url: "";
    in-out property <int> method-index: 0;
    in-out property <string> request-body: "";

    // Response state (0=Idle, 1=Loading, 2=Success, 3=Error)
    in-out property <int> response-state: 0;

    // Response data
    in-out property <int> status-code: 0;
    in-out property <string> status-text: "";
    in-out property <string> response-body: "";
    in-out property <string> duration: "";
    in-out property <string> size: "";

    // Error data
    in-out property <string> error-title: "";
    in-out property <string> error-message: "";
    in-out property <[string]> error-suggestions: [];

    // Loading data
    in-out property <string> elapsed-time: "0ms";

    // Helper to check if method needs body
    property <bool> show-body-editor: method-index == 1 || method-index == 2 || method-index == 3;

    // Callbacks to Rust
    callback send-request();
    callback cancel-request();
    callback copy-response-body();

    // Collection/Workspace callbacks (Sprint 02)
    callback open-workspace();
    callback create-workspace();
    callback close-workspace();
    callback item-selected(TreeItem);
    callback item-double-clicked(TreeItem);
    callback toggle-folder(TreeItem);
    callback new-request-clicked();
    callback new-folder-clicked();
    callback save-collection();

    // Collection/Workspace state (Sprint 02)
    in-out property <string> workspace-path: "";
    in-out property <[TreeItem]> collection-items: [];
    in-out property <string> selected-item-id: "";
    in-out property <string> current-collection-name: "";
    in-out property <bool> has-unsaved-changes: false;
    in-out property <bool> is-saving: false;

    VerticalLayout {
        spacing: 0;

        // Title bar - fixed height
        Rectangle {
            height: 36px;
            background: VortexPalette.bg-secondary;
            border-width: 1px;
            border-color: VortexPalette.border-default;

            HorizontalLayout {
                padding-left: VortexSpacing.md;
                padding-right: VortexSpacing.md;

                Text {
                    text: "Vortex";
                    color: VortexPalette.text-primary;
                    font-size: VortexTypography.font-lg;
                    font-weight: VortexTypography.weight-bold;
                    vertical-alignment: center;
                }

                Rectangle { horizontal-stretch: 1; }

                Text {
                    text: "v0.1.0";
                    color: VortexPalette.text-secondary;
                    font-size: VortexTypography.font-sm;
                    vertical-alignment: center;
                }
            }
        }

        // Main content area - fills remaining space
        HorizontalLayout {
            vertical-stretch: 1;
            spacing: 0;

            // Sidebar with collections - fixed width
            Rectangle {
                width: 280px;
                background: VortexPalette.bg-secondary;
                border-width: 1px;
                border-color: VortexPalette.border-default;

                VerticalLayout {
                    spacing: 0;

                    // Workspace selector
                    Rectangle {
                        height: workspace-path == "" ? 100px : 80px;
                        background: VortexPalette.bg-tertiary;

                        VerticalLayout {
                            padding: VortexSpacing.sm;
                            spacing: VortexSpacing.xs;

                            Text {
                                text: workspace-path == "" ? "No Workspace" : "Workspace";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-xs;
                                font-weight: VortexTypography.weight-bold;
                            }

                            if workspace-path != "": Text {
                                text: workspace-path;
                                color: VortexPalette.text-primary;
                                font-size: VortexTypography.font-sm;
                                overflow: elide;
                            }

                            HorizontalLayout {
                                spacing: VortexSpacing.xs;

                                Button {
                                    text: "Open";
                                    clicked => { open-workspace(); }
                                }

                                Button {
                                    text: "New";
                                    clicked => { create-workspace(); }
                                }

                                if workspace-path != "": Button {
                                    text: "Close";
                                    clicked => { close-workspace(); }
                                }
                            }
                        }
                    }

                    // Collections header
                    Rectangle {
                        height: 40px;
                        background: VortexPalette.bg-secondary;

                        HorizontalLayout {
                            padding-left: VortexSpacing.md;
                            padding-right: VortexSpacing.sm;
                            alignment: space-between;

                            Text {
                                text: "COLLECTIONS";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-xs;
                                font-weight: VortexTypography.weight-bold;
                                letter-spacing: 0.5px;
                                vertical-alignment: center;
                            }

                            HorizontalLayout {
                                spacing: VortexSpacing.xs;

                                Button {
                                    text: "+";
                                    enabled: workspace-path != "";
                                    clicked => { new-request-clicked(); }
                                }
                            }
                        }
                    }

                    // Collection tree
                    if collection-items.length > 0: CollectionTreeView {
                        vertical-stretch: 1;
                        items: collection-items;
                        selected-id <=> selected-item-id;

                        item-selected(item) => { root.item-selected(item); }
                        item-double-clicked(item) => { root.item-double-clicked(item); }
                        toggle-folder(item) => { root.toggle-folder(item); }
                    }

                    // Empty state
                    if collection-items.length == 0: Rectangle {
                        vertical-stretch: 1;

                        Text {
                            text: workspace-path == "" ?
                                "Open or create a workspace\nto see collections" :
                                "No collections yet\n\nCreate a new collection\nto get started";
                            color: VortexPalette.text-placeholder;
                            font-size: VortexTypography.font-sm;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }

                    // Save indicator
                    if has-unsaved-changes: Rectangle {
                        height: 32px;
                        background: #fff3e0;

                        HorizontalLayout {
                            padding: VortexSpacing.sm;
                            alignment: space-between;

                            Text {
                                text: "Unsaved changes";
                                color: #e65100;
                                font-size: VortexTypography.font-sm;
                                vertical-alignment: center;
                            }

                            Button {
                                text: is-saving ? "Saving..." : "Save";
                                enabled: !is-saving;
                                clicked => { save-collection(); }
                            }
                        }
                    }
                }
            }

            // Main editor area - fills remaining width
            Rectangle {
                horizontal-stretch: 1;
                background: VortexPalette.bg-primary;

                VerticalLayout {
                    spacing: 0;

                    // URL Bar - fixed height
                    UrlBar {
                        url <=> root.url;
                        method-index <=> root.method-index;
                        is-loading: response-state == 1;

                        send-clicked => { send-request(); }
                        cancel-clicked => { cancel-request(); }
                    }

                    // Request body editor - fixed height, visibility controlled
                    Rectangle {
                        height: show-body-editor ? 200px : 0px;
                        background: VortexPalette.bg-primary;
                        border-width: show-body-editor ? 1px : 0px;
                        border-color: VortexPalette.border-default;
                        clip: true;
                        visible: show-body-editor;

                        VerticalLayout {
                            padding: VortexSpacing.sm;
                            spacing: VortexSpacing.xs;

                            Text {
                                text: "Request Body (JSON)";
                                color: VortexPalette.text-secondary;
                                font-size: VortexTypography.font-sm;
                            }

                            Rectangle {
                                vertical-stretch: 1;
                                background: VortexPalette.bg-input;
                                border-radius: 4px;
                                border-width: 1px;
                                border-color: body-editor.has-focus ? VortexPalette.border-focus : VortexPalette.border-default;
                                clip: true;

                                body-editor := TextEdit {
                                    x: 8px;
                                    y: 8px;
                                    width: parent.width - 16px;
                                    height: parent.height - 16px;
                                    text <=> request-body;
                                    font-size: VortexTypography.font-base;
                                    read-only: false;
                                    wrap: word-wrap;
                                }
                            }
                        }
                    }

                    // Response panel - fills remaining vertical space
                    ResponsePanel {
                        vertical-stretch: 1;
                        state: response-state;
                        status-code: root.status-code;
                        status-text: root.status-text;
                        response-body: root.response-body;
                        duration: root.duration;
                        size: root.size;
                        error-title: root.error-title;
                        error-message: root.error-message;
                        error-suggestions: root.error-suggestions;
                        elapsed-time: root.elapsed-time;

                        retry-clicked => { send-request(); }
                        copy-body-clicked => { copy-response-body(); }
                    }
                }
            }
        }
    }
}
